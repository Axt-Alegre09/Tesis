<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gestión de Promos - Paniquiños Admin</title>
  
  <link rel="shortcut icon" href="https://jyygevitfnbwrvxrjexp.supabase.co/storage/v1/object/public/productos/paniquinosico.ico" type="image/x-icon">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
  <link rel="stylesheet" href="CSS/promos.css">
  
  <!-- Script para detectar tema del padre (iframe) -->
  <script>
    (function() {
      // Función para aplicar tema
      function applyTheme(theme) {
        document.documentElement.setAttribute('data-theme', theme);
      }
      
      // Detectar tema del padre si estamos en un iframe
      function detectParentTheme() {
        try {
          if (window.parent && window.parent !== window) {
            const parentTheme = window.parent.document.documentElement.getAttribute('data-theme');
            if (parentTheme) {
              applyTheme(parentTheme);
              return true;
            }
          }
        } catch (e) {
          // Cross-origin, intentar con localStorage
        }
        
        // Fallback: usar localStorage
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme) {
          applyTheme(savedTheme);
          return true;
        }
        
        return false;
      }
      
      // Aplicar tema inmediatamente
      detectParentTheme();
      
      // Observar cambios en el padre
      function observeParentTheme() {
        try {
          if (window.parent && window.parent !== window) {
            const observer = new MutationObserver(function(mutations) {
              mutations.forEach(function(mutation) {
                if (mutation.attributeName === 'data-theme') {
                  const newTheme = window.parent.document.documentElement.getAttribute('data-theme');
                  applyTheme(newTheme || 'light');
                }
              });
            });
            
            observer.observe(window.parent.document.documentElement, {
              attributes: true,
              attributeFilter: ['data-theme']
            });
          }
        } catch (e) {
          // Cross-origin, usar intervalo como fallback
          setInterval(function() {
            const savedTheme = localStorage.getItem('theme');
            const currentTheme = document.documentElement.getAttribute('data-theme');
            if (savedTheme && savedTheme !== currentTheme) {
              applyTheme(savedTheme);
            }
          }, 500);
        }
      }
      
      // Iniciar observador cuando el DOM esté listo
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', observeParentTheme);
      } else {
        observeParentTheme();
      }
    })();
  </script>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <div class="header">
      <div>
        <h1 class="title">Gestión de Promociones</h1>
        <p class="subtitle">Crea y administra descuentos para tus productos</p>
      </div>
      <button class="btn-primary" id="btnNuevaPromo">
        <i class="bi bi-plus-lg"></i>
        Nueva Promo
      </button>
    </div>

    <!-- Tabla de Promos -->
    <div class="card">
      <div class="table-container">
        <table class="table">
          <thead>
            <tr>
              <th>Nombre</th>
              <th>Tipo</th>
              <th class="text-center">Valor</th>
              <th>Vigencia</th>
              <th class="text-center">Estado</th>
              <th class="text-center">Acciones</th>
            </tr>
          </thead>
          <tbody id="promosTableBody">
            <tr>
              <td colspan="6" class="loading-cell">
                <div class="spinner"></div>
                <p>Cargando promos...</p>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Modal Agregar/Editar Promo -->
  <div class="modal-overlay" id="modalPromo">
    <div class="modal">
      <button class="modal-close" id="closeModalPromo">
        <i class="bi bi-x-lg"></i>
      </button>
      
      <h2 class="modal-title" id="modalPromoTitle">Nueva Promoción</h2>
      
      <form id="formPromo" class="form">
        <input type="hidden" id="promoId">
        
        <!-- Nombre -->
        <div class="form-group">
          <label for="promoNombre" class="form-label">Nombre de la promoción *</label>
          <input 
            type="text" 
            id="promoNombre" 
            class="form-input"
            required 
            placeholder="Ej: Black Friday 2025"
          >
        </div>

        <!-- Descripción -->
        <div class="form-group">
          <label for="promoDescripcion" class="form-label">Descripción</label>
          <textarea 
            id="promoDescripcion" 
            class="form-input"
            rows="2"
            placeholder="Descripción de la promoción..."
          ></textarea>
        </div>

        <!-- Tipo de descuento -->
        <div class="form-group">
          <label for="promoTipo" class="form-label">Tipo de descuento *</label>
          <select id="promoTipo" class="form-input" required>
            <option value="">Selecciona el tipo</option>
            <option value="porcentaje">Porcentaje (%) - Ejemplo: 30% de descuento</option>
            <option value="monto_fijo">Monto fijo (Gs) - Ejemplo: 5.000 Gs de descuento</option>
            <option value="precio_especial">Precio especial - Ejemplo: Producto a 20.000 Gs</option>
          </select>
        </div>

        <!-- Valor -->
        <div class="form-group">
          <label for="promoValor" class="form-label">Valor *</label>
          <input 
            type="number" 
            id="promoValor" 
            class="form-input"
            required 
            min="0"
            step="0.01"
            placeholder="Ejemplo: 30 (para 30%)"
          >
          <small class="form-help">
            • Para porcentaje: ingresa 0-100<br>
            • Para monto fijo: ingresa los Gs a descontar<br>
            • Para precio especial: ingresa el precio final
          </small>
        </div>

        <!-- Fechas -->
        <div class="form-row">
          <div class="form-group">
            <label for="promoFechaInicio" class="form-label">Fecha inicio *</label>
            <input 
              type="date" 
              id="promoFechaInicio" 
              class="form-input"
              required 
            >
          </div>
          <div class="form-group">
            <label for="promoFechaFin" class="form-label">Fecha fin *</label>
            <input 
              type="date" 
              id="promoFechaFin" 
              class="form-input"
              required 
            >
          </div>
        </div>

        <!-- Código promocional -->
        <div class="form-group">
          <label for="promoCodigo" class="form-label">Código promocional (opcional)</label>
          <input 
            type="text" 
            id="promoCodigo" 
            class="form-input"
            placeholder="Ej: VERANO2025"
            maxlength="50"
            style="text-transform: uppercase;"
          >
          <small class="form-help">
            Código único para esta promo (se convierte a mayúsculas automáticamente)
          </small>
        </div>

        <!-- Activo -->
        <div class="form-check">
          <input type="checkbox" id="promoActivo" class="form-checkbox" checked>
          <label for="promoActivo" class="form-check-label">Activar promoción</label>
        </div>

        <!-- Botones -->
        <div class="form-actions">
          <button type="button" class="btn-secondary" id="btnCancelarPromo">
            Cancelar
          </button>
          <button type="submit" class="btn-primary">
            <i class="bi bi-check-lg"></i>
            Guardar Promo
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal Asignar Productos -->
  <div class="modal-overlay" id="modalAsignarProductos">
    <div class="modal modal-large">
      <button class="modal-close" id="closeModalAsignar">
        <i class="bi bi-x-lg"></i>
      </button>
      
      <h2 class="modal-title" id="modalAsignarTitle">Asignar productos</h2>
      <p class="modal-subtitle">Selecciona los productos a los que quieres aplicar esta promoción</p>
      
      <!-- BUSCADOR -->
      <div id="searchContainerPromos" style="margin-bottom: 1.5rem;">
        <!-- Se llena dinámicamente con el buscador -->
      </div>

      <!-- Lista de productos -->
      <div id="productosAsignarList" class="productos-list">
        <!-- Se llena dinámicamente -->
      </div>

      <!-- Botones -->
      <div class="form-actions">
        <button type="button" class="btn-secondary" id="btnCancelarAsignar">
          Cancelar
        </button>
        <button type="button" class="btn-primary" id="btnGuardarAsignar">
          <i class="bi bi-check-lg"></i>
          Guardar Asignación
        </button>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script type="module" src="JS/promos.js"></script>
</body>
</html>