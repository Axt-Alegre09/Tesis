<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title> g - PaniquiÃ±os</title>
  <link rel="shortcut icon" href="https://jyygevitfnbwrvxrjexp.supabase.co/storage/v1/object/public/productos/paniquinosico.ico" type="image/x-icon">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="CSS/catering.css" />
</head>
<body>
  <div class="catering-app">
    
    <!-- BARRA SUPERIOR -->
    <div class="top-bar">
      <div class="bar-left">
        <div class="filter-pills">
          <button class="pill active" data-filter="all">
            <span class="count">0</span>Todos
          </button>
          <button class="pill" data-filter="pending">
            <span class="count">0</span>Pendientes
          </button>
          <button class="pill" data-filter="in-progress">
            <span class="count">0</span>En Curso
          </button>
          <button class="pill" data-filter="completed">
            <span class="count">0</span>Finalizados
          </button>
        </div>
      </div>

      <div class="bar-right">
        <div class="search-wrapper">
          <input type="search" id="searchInput" class="search-field" placeholder="Buscar..." />
        </div>
        <button id="btnNew" class="btn-new-main">+ Agendar</button>
      </div>
    </div>

    <!-- TABLA PRINCIPAL -->
    <section class="table-container">
      <table class="main-table">
        <thead>
          <tr>
            <th>Cliente</th>
            <th>TelÃ©fono</th>
            <th>Fecha</th>
            <th>Invitados</th>
            <th>Estado</th>
            <th class="col-actions">Acciones</th>
          </tr>
        </thead>
        <tbody id="tableBody">
          <!-- DinÃ¡mico -->
        </tbody>
      </table>

      <div id="emptyMsg" class="no-data">
        <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
          <path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
        </svg>
        <p>No hay reservas</p>
      </div>
    </section>

  </div>

  <!-- MODAL DRAWER -->
  <div id="modalBackdrop" class="modal-backdrop"></div>
  <div id="modalDrawer" class="modal-drawer">
    <div class="drawer-header">
      <h2 id="drawerTitle">Nueva Reserva</h2>
      <button id="btnCloseModal" class="close-btn">âœ•</button>
    </div>

    <form id="mainForm" class="main-form">
      <!-- FILA 1 -->
      <div class="form-row">
        <div class="form-col">
          <label>Nombre *</label>
          <input id="f_nombre" type="text" placeholder="Cliente" required />
        </div>
        <div class="form-col">
          <label>TelÃ©fono *</label>
          <input id="f_telefono" type="tel" placeholder="0991 000 000" required />
        </div>
      </div>

      <!-- FILA 2 -->
      <div class="form-row">
        <div class="form-col">
          <label>Email</label>
          <input id="f_email" type="email" placeholder="correo@ejemplo.com" />
        </div>
        <div class="form-col">
          <label>DirecciÃ³n</label>
          <input id="f_direccion" type="text" placeholder="UbicaciÃ³n" />
        </div>
      </div>

      <!-- FILA 3 -->
      <div class="form-row">
        <div class="form-col">
          <label>Tipo Servicio</label>
          <input id="f_tipo" type="text" placeholder="Catering" />
        </div>
        <div class="form-col">
          <label>MenÃº</label>
          <input id="f_menu" type="text" placeholder="Seleccionar" />
        </div>
      </div>

      <!-- FILA 4 -->
      <div class="form-row">
        <div class="form-col">
          <label>Invitados *</label>
          <input id="f_invitados" type="number" min="1" placeholder="0" required />
        </div>
        <div class="form-col">
          <label>Fecha *</label>
          <input id="f_fecha" type="date" required />
        </div>
      </div>

      <!-- FILA 5 -->
      <div class="form-row">
        <div class="form-col">
          <label>Hora *</label>
          <input id="f_hora" type="time" required />
        </div>
        <div class="form-col" id="statusCol" style="display: none;">
          <label>Estado</label>
          <select id="f_estado">
            <option value="pending">Pendiente</option>
            <option value="in-progress">En Curso</option>
            <option value="completed">Finalizado</option>
          </select>
        </div>
      </div>

      <!-- BOTONES -->
      <div class="form-footer">
        <button type="button" id="btnModalCancel" class="btn-cancel">Cancelar</button>
        <button type="submit" id="btnModalSave" class="btn-save">Agendar</button>
        <button type="button" id="btnModalDelete" class="btn-delete" style="display: none;">Eliminar</button>
      </div>
    </form>
  </div>

  <!-- TOAST -->
  <div id="toastArea" class="toast-area"></div>

  <!-- ==================== CATERING.HTML - SCRIPT CORREGIDO ==================== -->
<!-- Este cÃ³digo va dentro de catering.html, reemplazando las funciones existentes -->

<script type="module">
import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';

const supabase = createClient(
  'https://jyygevitfnbwrvxrjexp.supabase.co',
  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp5eWdldml0Zm5id3J2eHJqZXhwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU2OTQ2OTYsImV4cCI6MjA3MTI3MDY5Nn0.St0IiSZSeELESshctneazCJHXCDBi9wrZ28UkiEDXYo'
);

// ========== CARGAR RESERVAS ==========
async function cargarReservas() {
  console.log('ðŸ”„ Cargando reservas de catering...');
  
  const tbody = document.getElementById('cateringTableBody');
  if (!tbody) return;
  
  tbody.innerHTML = `
    <tr>
      <td colspan="8" style="padding: 3rem; text-align: center; color: var(--text-muted);">
        <div class="spinner"></div>
        <p>Cargando reservas...</p>
      </td>
    </tr>
  `;
  
  try {
    const { data, error } = await supabase
      .from('reservas_catering')
      .select('*')
      .order('fecha', { ascending: false });

    if (error) throw error;
    
    console.log(`âœ… ${data.length} reservas cargadas`);
    renderReservas(data);
    
  } catch (error) {
    console.error('Error cargando reservas:', error);
    tbody.innerHTML = `
      <tr>
        <td colspan="8" style="padding: 2rem; text-align: center; color: var(--danger);">
          <i class="bi bi-exclamation-triangle" style="font-size: 2rem;"></i>
          <p>Error cargando reservas</p>
        </td>
      </tr>
    `;
  }
}

// ========== RENDERIZAR TABLA ==========
function renderReservas(reservas) {
  const tbody = document.getElementById('cateringTableBody');
  if (!tbody) return;
  
  if (!reservas || reservas.length === 0) {
    tbody.innerHTML = `
      <tr>
        <td colspan="8" style="padding: 3rem; text-align: center; color: var(--text-muted);">
          <i class="bi bi-inbox" style="font-size: 3rem;"></i>
          <p>No hay reservas de catering</p>
        </td>
      </tr>
    `;
    return;
  }

  tbody.innerHTML = reservas.map(reserva => {
    const fecha = new Date(reserva.fecha).toLocaleDateString('es-PY');
    const estadoColor = getEstadoColor(reserva.estado);
    
    return `
      <tr style="border-bottom: 1px solid var(--border);">
        <td style="padding: 1rem;">
          <div style="font-weight: 600;">${reserva.razonsocial}</div>
          <div style="font-size: 0.85rem; color: var(--text-muted);">RUC: ${reserva.ruc || '-'}</div>
        </td>
        <td style="padding: 1rem;">${reserva.tipoevento || '-'}</td>
        <td style="padding: 1rem;">
          <div>${fecha}</div>
          <div style="font-size: 0.85rem; color: var(--text-muted);">${reserva.hora || '-'}</div>
        </td>
        <td style="padding: 1rem;">${reserva.tipocomida || '-'}</td>
        <td style="padding: 1rem;">${reserva.invitados || 0}</td>
        <td style="padding: 1rem; text-align: center;">
          <span style="
            padding: 0.4rem 0.75rem; 
            border-radius: 6px; 
            font-size: 0.85rem;
            background: ${estadoColor.bg};
            color: ${estadoColor.text};
          ">
            ${reserva.estado}
          </span>
        </td>
        <td style="padding: 1rem; font-size: 0.85rem; color: var(--text-muted);">
          ${reserva.telefono || '-'}<br>
          ${reserva.email || '-'}
        </td>
        <td style="padding: 1rem; text-align: center;">
          <select 
            class="estado-select" 
            data-id="${reserva.id}"
            data-estado-actual="${reserva.estado}"
            style="
              padding: 0.5rem; 
              border: 1px solid var(--border); 
              border-radius: 6px; 
              font-size: 0.85rem;
              cursor: pointer;
              min-width: 120px;
            "
          >
            <option value="pendiente" ${reserva.estado === 'pendiente' ? 'selected' : ''}>Pendiente</option>
            <option value="en curso" ${reserva.estado === 'en curso' ? 'selected' : ''}>En Curso</option>
            <option value="finalizado" ${reserva.estado === 'finalizado' ? 'selected' : ''}>Finalizado</option>
            <option value="cancelado" ${reserva.estado === 'cancelado' ? 'selected' : ''}>Cancelado</option>
          </select>
          <button 
            class="icon-btn" 
            onclick="eliminarReserva('${reserva.id}', '${reserva.razonsocial.replace(/'/g, "\\'")}')" 
            title="Eliminar"
            style="
              background: rgba(239,68,68,0.1); 
              color: rgb(239,68,68); 
              border: none; 
              padding: 0.5rem; 
              border-radius: 6px; 
              cursor: pointer;
              margin-left: 0.5rem;
            "
          >
            <i class="bi bi-trash"></i>
          </button>
        </td>
      </tr>
    `;
  }).join('');
  
  // âœ… CORRECCIÃ“N: Agregar event listeners a los selects de estado
  document.querySelectorAll('.estado-select').forEach(select => {
    select.addEventListener('change', async (e) => {
      const id = e.target.dataset.id;
      const estadoActual = e.target.dataset.estadoActual;
      const nuevoEstado = e.target.value;
      
      if (nuevoEstado === estadoActual) return;
      
      const confirmado = confirm(`Â¿Cambiar el estado de la reserva a "${nuevoEstado}"?`);
      
      if (confirmado) {
        await actualizarEstado(id, nuevoEstado);
      } else {
        // Revertir el select al estado anterior
        e.target.value = estadoActual;
      }
    });
  });
}

// âœ… CORRECCIÃ“N: FunciÃ³n para actualizar el estado
async function actualizarEstado(id, nuevoEstado) {
  console.log('ðŸ”„ Actualizando estado de catering:', id, nuevoEstado);
  
  try {
    const { error } = await supabase
      .from('reservas_catering')
      .update({ 
        estado: nuevoEstado,
        actualizado_en: new Date().toISOString()
      })
      .eq('id', id);

    if (error) throw error;

    showToast(`âœ… Estado actualizado a: ${nuevoEstado}`, 'success');
    await cargarReservas();
    
  } catch (error) {
    console.error('Error al actualizar estado:', error);
    showToast('âŒ Error al actualizar el estado', 'error');
  }
}

// ========== ELIMINAR RESERVA ==========
async function eliminarReserva(id, razonSocial) {
  console.log('ðŸ—‘ï¸ Eliminando reserva:', id, razonSocial);
  
  const confirmado = confirm(`Â¿EstÃ¡s seguro de eliminar la reserva de "${razonSocial}"?\n\nEsta acciÃ³n no se puede deshacer.`);
  
  if (!confirmado) return;

  try {
    const { error } = await supabase
      .from('reservas_catering')
      .delete()
      .eq('id', id);

    if (error) throw error;

    showToast('âœ… Reserva eliminada exitosamente', 'success');
    await cargarReservas();
    
  } catch (error) {
    console.error('Error al eliminar:', error);
    showToast('âŒ Error al eliminar la reserva', 'error');
  }
}

// ========== HELPERS ==========
function getEstadoColor(estado) {
  const estados = {
    'pendiente': { bg: 'rgba(245,158,11,0.1)', text: 'rgb(245,158,11)' },
    'en curso': { bg: 'rgba(59,130,246,0.1)', text: 'rgb(59,130,246)' },
    'finalizado': { bg: 'rgba(16,185,129,0.1)', text: 'rgb(16,185,129)' },
    'cancelado': { bg: 'rgba(239,68,68,0.1)', text: 'rgb(239,68,68)' }
  };
  
  return estados[estado] || estados['pendiente'];
}

function showToast(message, type = 'success') {
  const bgColor = type === 'success' ? 'rgb(16, 185, 129)' : 'rgb(239, 68, 68)';
  const toast = document.createElement('div');
  toast.style.cssText = `
    position: fixed;
    top: 20px;
    right: 20px;
    background: ${bgColor};
    color: white;
    padding: 1rem 1.5rem;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    z-index: 10000;
    font-weight: 500;
  `;
  toast.textContent = message;
  document.body.appendChild(toast);
  
  setTimeout(() => {
    toast.style.opacity = '0';
    toast.style.transition = 'opacity 0.3s';
    setTimeout(() => toast.remove(), 300);
  }, 3000);
}

// ========== EXPORTAR FUNCIONES GLOBALMENTE ==========
window.cargarReservas = cargarReservas;
window.eliminarReserva = eliminarReserva;
window.actualizarEstado = actualizarEstado;

// ========== INICIALIZAR AL CARGAR ==========
document.addEventListener('DOMContentLoaded', () => {
  console.log('ðŸš€ Inicializando mÃ³dulo de catering...');
  cargarReservas();
});

// Recargar cada 30 segundos
setInterval(() => {
  cargarReservas();
}, 30000);

console.log('âœ… MÃ³dulo de catering cargado correctamente');
</script>
</body> 
</html>